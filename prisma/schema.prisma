// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  student
  instructor
  admin
}

enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  no_show
}

enum PaymentStatus {
  pending
  processing
  succeeded
  failed
  refunded
  partially_refunded
}

enum StudentLevel {
  beginner
  intermediate
  advanced
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique @db.VarChar(255)
  passwordHash    String?   @map("password_hash") @db.VarChar(255) // Optional for OAuth
  firstName       String    @map("first_name") @db.VarChar(100)
  lastName        String    @map("last_name") @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  profileImageUrl String?   @map("profile_image_url")
  userType        UserType  @map("user_type")
  emailVerified   DateTime? @map("email_verified")
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  instructorProfile InstructorProfile?
  bookingsAsStudent Booking[]          @relation("StudentBookings")
  messagesSent      Message[]          @relation("SentMessages")
  messagesReceived  Message[]          @relation("ReceivedMessages")
  reviews           Review[]
  notifications     Notification[]
  auditLogs         AuditLog[]

  @@index([email])
  @@index([userType])
  @@map("users")
}

model InstructorProfile {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @unique @map("user_id") @db.Uuid
  bio                   String?  @db.Text
  experienceYears       Int?     @map("experience_years")
  certifications        Json?    @default("[]")
  specialties           Json?    @default("[]")
  hourlyRate            Decimal  @map("hourly_rate") @db.Decimal(10, 2)
  isVerified            Boolean  @default(false) @map("is_verified")
  verificationDocuments Json?    @default("[]") @map("verification_documents")
  averageRating         Decimal  @default(0.00) @map("average_rating") @db.Decimal(3, 2)
  totalReviews          Int      @default(0) @map("total_reviews")
  totalClasses          Int      @default(0) @map("total_classes")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  availability InstructorAvailability[]
  bookings     Booking[]
  reviews      Review[]

  @@index([userId])
  @@index([isVerified])
  @@index([averageRating(sort: Desc)])
  @@map("instructor_profiles")
}

model Location {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  address     String   @db.Text
  city        String   @db.VarChar(100)
  state       String?  @db.VarChar(100)
  country     String   @db.VarChar(100)
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  description String?  @db.Text
  imageUrl    String?  @map("image_url")
  difficulty  String?  @db.VarChar(50)
  surfType    String?  @map("surf_type") @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  availabilities InstructorAvailability[]
  bookings       Booking[]

  @@index([latitude, longitude])
  @@index([city])
  @@map("locations")
}

model InstructorAvailability {
  id           String   @id @default(uuid()) @db.Uuid
  instructorId String   @map("instructor_id") @db.Uuid
  locationId   String   @map("location_id") @db.Uuid
  date         DateTime @db.Date
  startTime    DateTime @map("start_time") @db.Time
  endTime      DateTime @map("end_time") @db.Time
  isAvailable  Boolean  @default(true) @map("is_available")
  maxStudents  Int      @default(1) @map("max_students")
  currentBookings Int   @default(0) @map("current_bookings")
  createdAt    DateTime @default(now()) @map("created_at")

  instructor InstructorProfile @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  location   Location          @relation(fields: [locationId], references: [id])
  bookings   Booking[]

  @@unique([instructorId, date, startTime])
  @@index([instructorId])
  @@index([locationId])
  @@index([date])
  @@map("instructor_availability")
}

model Booking {
  id                 String        @id @default(uuid()) @db.Uuid
  studentId          String        @map("student_id") @db.Uuid
  instructorId       String        @map("instructor_id") @db.Uuid
  availabilityId     String?       @map("availability_id") @db.Uuid
  locationId         String        @map("location_id") @db.Uuid
  bookingDate        DateTime      @map("booking_date") @db.Date
  startTime          DateTime      @map("start_time") @db.Time
  endTime            DateTime      @map("end_time") @db.Time
  status             BookingStatus @default(pending)
  price              Decimal       @db.Decimal(10, 2)
  studentLevel       StudentLevel? @map("student_level")
  specialRequests    String?       @map("special_requests") @db.Text
  cancellationReason String?       @map("cancellation_reason") @db.Text
  cancelledBy        String?       @map("cancelled_by") @db.Uuid
  cancelledAt        DateTime?     @map("cancelled_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  student      User                    @relation("StudentBookings", fields: [studentId], references: [id])
  instructor   InstructorProfile       @relation(fields: [instructorId], references: [id])
  availability InstructorAvailability? @relation(fields: [availabilityId], references: [id])
  location     Location                @relation(fields: [locationId], references: [id])
  payment      Payment?
  review       Review?
  messages     Message[]

  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@index([bookingDate])
  @@map("bookings")
}

model Payment {
  id                    String        @id @default(uuid()) @db.Uuid
  bookingId             String        @unique @map("booking_id") @db.Uuid
  stripePaymentIntentId String?       @unique @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId        String?       @map("stripe_charge_id") @db.VarChar(255)
  amount                Decimal       @db.Decimal(10, 2)
  platformFee           Decimal       @map("platform_fee") @db.Decimal(10, 2)
  instructorAmount      Decimal       @map("instructor_amount") @db.Decimal(10, 2)
  currency              String        @default("USD") @db.VarChar(3)
  status                PaymentStatus @default(pending)
  paymentMethod         String?       @map("payment_method") @db.VarChar(50)
  refundAmount          Decimal?      @default(0.00) @map("refund_amount") @db.Decimal(10, 2)
  refundReason          String?       @map("refund_reason") @db.Text
  metadata              Json?         @default("{}")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([stripePaymentIntentId])
  @@index([status])
  @@map("payments")
}

model Review {
  id                   String    @id @default(uuid()) @db.Uuid
  bookingId            String    @unique @map("booking_id") @db.Uuid
  studentId            String    @map("student_id") @db.Uuid
  instructorId         String    @map("instructor_id") @db.Uuid
  rating               Int
  comment              String?   @db.Text
  instructorResponse   String?   @map("instructor_response") @db.Text
  instructorRespondedAt DateTime? @map("instructor_responded_at")
  isVisible            Boolean   @default(true) @map("is_visible")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  booking    Booking           @relation(fields: [bookingId], references: [id])
  student    User              @relation(fields: [studentId], references: [id])
  instructor InstructorProfile @relation(fields: [instructorId], references: [id])

  @@index([instructorId])
  @@index([rating])
  @@map("reviews")
}

model Message {
  id          String    @id @default(uuid()) @db.Uuid
  bookingId   String    @map("booking_id") @db.Uuid
  senderId    String    @map("sender_id") @db.Uuid
  receiverId  String    @map("receiver_id") @db.Uuid
  messageText String    @map("message_text") @db.Text
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  booking  Booking @relation(fields: [bookingId], references: [id])
  sender   User    @relation("SentMessages", fields: [senderId], references: [id])
  receiver User    @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([bookingId])
  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model Notification {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  type              String    @db.VarChar(50)
  title             String    @db.VarChar(255)
  message           String    @db.Text
  relatedEntityType String?   @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   String?   @map("related_entity_id") @db.Uuid
  isRead            Boolean   @default(false) @map("is_read")
  readAt            DateTime? @map("read_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Uuid
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
